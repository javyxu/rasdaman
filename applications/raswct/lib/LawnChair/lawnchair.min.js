var Lawnchair=function(c,f){if(!(this instanceof Lawnchair))return new Lawnchair(c,f);if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(arguments.length<=2&&arguments.length>0){f=typeof arguments[0]==="function"?arguments[0]:arguments[1];c=typeof arguments[0]==="function"?{}:arguments[0]}else throw"Incorrect # of ctor args!";if(typeof f!=="function")throw"No callback was provided";this.record=c.record||"record";this.name=c.name||"records";var d;if(c.adapter)for(var a=
  0,b=Lawnchair.adapters.length;a<b;a++){if(Lawnchair.adapters[a].adapter===c.adapter){d=Lawnchair.adapters[a].valid()?Lawnchair.adapters[a]:undefined;break}}else{a=0;for(b=Lawnchair.adapters.length;a<b;a++)if(d=Lawnchair.adapters[a].valid()?Lawnchair.adapters[a]:undefined)break}if(!d)throw"No valid adapter.";for(var e in d)this[e]=d[e];a=0;for(b=Lawnchair.plugins.length;a<b;a++)Lawnchair.plugins[a].call(this);this.init(c,f)};Lawnchair.adapters=[];
Lawnchair.adapter=function(c,f){f.adapter=c;var d="adapter valid init keys save batch get exists all remove nuke".split(" "),a=this.prototype.indexOf,b;for(b in f)if(a(d,b)===-1)throw"Invalid adapter! Nonstandard method: "+b;Lawnchair.adapters.splice(0,0,f)};Lawnchair.plugins=[];Lawnchair.plugin=function(c){for(var f in c)f==="init"?Lawnchair.plugins.push(c[f]):this.prototype[f]=c[f]};
Lawnchair.prototype={isArray:Array.isArray||function(c){return Object.prototype.toString.call(c)==="[object Array]"},indexOf:function(c,f,d,a){if(c.indexOf)return c.indexOf(f);d=0;for(a=c.length;d<a;d++)if(c[d]===f)return d;return-1},lambda:function(c){return this.fn(this.record,c)},fn:function(c,f){return typeof f=="string"?new Function(c,f):f},uuid:function(){var c=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};return c()+c()+"-"+c()+"-"+c()+"-"+c()+"-"+c()+c()+c()},each:function(c){var f=
  this.lambda(c);if(this.__results){c=0;for(var d=this.__results.length;c<d;c++)f.call(this,this.__results[c],c)}else this.all(function(a){for(var b=0,e=a.length;b<e;b++)f.call(this,a[b],b)});return this}};
Lawnchair.adapter("dom",function(){var c=window.localStorage,f=function(d){return{key:d+"._index_",all:function(){var a=c.getItem(this.key);if(a)a=JSON.parse(a);a===null&&c.setItem(this.key,JSON.stringify([]));return JSON.parse(c.getItem(this.key))},add:function(a){var b=this.all();b.push(a);c.setItem(this.key,JSON.stringify(b))},del:function(a){for(var b=this.all(),e=[],g=0,h=b.length;g<h;g++)b[g]!=a&&e.push(b[g]);c.setItem(this.key,JSON.stringify(e))},find:function(a){for(var b=this.all(),e=0,g=
  b.length;e<g;e++)if(a===b[e])return e;return false}}};return{valid:function(){return!!c},init:function(d,a){this.indexer=f(this.name);a&&this.fn(this.name,a).call(this,this)},save:function(d,a){var b=d.key?this.name+"."+d.key:this.name+"."+this.uuid();this.indexer.find(b)===false&&this.indexer.add(b);delete d.key;c.setItem(b,JSON.stringify(d));d.key=b.slice(this.name.length+1);a&&this.lambda(a).call(this,d);return this},batch:function(d,a){for(var b=[],e=0,g=d.length;e<g;e++)this.save(d[e],function(h){b.push(h)});
  a&&this.lambda(a).call(this,b);return this},keys:function(d){if(d){var a=this.name,b=this.indexer.all().map(function(e){return e.replace(a+".","")});this.fn("keys",d).call(this,b)}return this},get:function(d,a){if(this.isArray(d)){for(var b=[],e=0,g=d.length;e<g;e++){var h=this.name+"."+d[e];if(h=c.getItem(h)){h=JSON.parse(h);h.key=d[e];b.push(h)}}a&&this.lambda(a).call(this,b)}else{h=this.name+"."+d;if(h=c.getItem(h)){h=JSON.parse(h);h.key=d}a&&this.lambda(a).call(this,h)}return this},exists:function(d,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             a){var b=this.indexer.find(this.name+"."+d)===false?false:true;this.lambda(a).call(this,b);return this},all:function(d){for(var a=this.indexer.all(),b=[],e,g,h=0,i=a.length;h<i;h++){g=a[h];e=JSON.parse(c.getItem(g));e.key=g.replace(this.name+".","");b.push(e)}d&&this.fn(this.name,d).call(this,b);return this},remove:function(d,a){var b=this.name+"."+(d.key?d.key:d);this.indexer.del(b);c.removeItem(b);a&&this.lambda(a).call(this);return this},nuke:function(d){this.all(function(a){for(var b=0,e=a.length;b<
  e;b++)this.remove(a[b]);d&&this.lambda(d).call(this)});return this}}}());
Lawnchair.adapter("window-name",function(c,f){var d=window.top.name?JSON.parse(window.top.name):{};return{valid:function(){return typeof window.top.name!="undefined"},init:function(a,b){d[this.name]=d[this.name]||{index:[],store:{}};c=d[this.name].index;f=d[this.name].store;this.fn(this.name,b).call(this,this)},keys:function(a){this.fn("keys",a).call(this,c);return this},save:function(a,b){var e=a.key||this.uuid();a.key&&delete a.key;this.exists(e,function(g){g||c.push(e);f[e]=a;window.top.name=JSON.stringify(d);
  a.key=e;b&&this.lambda(b).call(this,a)});return this},batch:function(a,b){for(var e=[],g=0,h=a.length;g<h;g++)this.save(a[g],function(i){e.push(i)});b&&this.lambda(b).call(this,e);return this},get:function(a,b){var e;if(this.isArray(a)){e=[];for(var g=0,h=a.length;g<h;g++)e.push(f[a[g]])}else if(e=f[a])e.key=a;b&&this.lambda(b).call(this,e);return this},exists:function(a,b){this.lambda(b).call(this,!!f[a]);return this},all:function(a){for(var b=[],e=0,g=c.length;e<g;e++){var h=f[c[e]];h.key=c[e];
  b.push(h)}this.fn(this.name,a).call(this,b);return this},remove:function(a,b){for(var e=this.isArray(a)?a:[a],g=0,h=e.length;g<h;g++){delete f[e[g]];c.splice(this.indexOf(c,e[g]),1)}window.top.name=JSON.stringify(d);b&&this.lambda(b).call(this);return this},nuke:function(a){storage={};c=[];window.top.name=JSON.stringify(d);a&&this.lambda(a).call(this);return this}}}());

Lawnchair.adapter("webkit-sqlite",function(){var f=function(a,d){console.log("error in sqlite adaptor!",a,d)};Function.prototype.bind||(Function.prototype.bind=function(a){var d=[].slice,b=d.call(arguments,1),c=this,e=function(){},h=function(){return c.apply(this instanceof e?this:a||{},b.concat(d.call(arguments)))};e.prototype=c.prototype;h.prototype=new e;return h});return{valid:function(){return!!window.openDatabase},init:function(a,d){var b=this,c=b.fn(b.name,d),e="CREATE TABLE IF NOT EXISTS "+
  this.name+" (id NVARCHAR(32) UNIQUE PRIMARY KEY, value TEXT, timestamp REAL)",h=function(){return c.call(b,b)};this.db=openDatabase(this.name,"1.0.0",this.name,65536);this.db.transaction(function(a){a.executeSql(e,[],h,f)})},keys:function(a){var d=this.lambda(a),b=this,c="SELECT id FROM "+this.name+" ORDER BY timestamp DESC";this.db.transaction(function(a){a.executeSql(c,[],function(a,c){if(0==c.rows.length)d.call(b,[]);else{for(var e=[],g=0,l=c.rows.length;g<l;g++)e.push(c.rows.item(g).id);d.call(b,
  e)}},f)});return this},save:function(a,d){var b=this,c=a.key||b.uuid(),e="INSERT INTO "+this.name+" (value, timestamp, id) VALUES (?,?,?)",h="UPDATE "+this.name+" SET value=?, timestamp=? WHERE id=?",k=function(){d&&(a.key=c,b.lambda(d).call(b,a))},j=[new Date,c];b.exists(a.key,function(c){b.db.transaction(function(b){c?(delete a.key,j.unshift(JSON.stringify(a)),b.executeSql(h,j,k,f)):(j.unshift(JSON.stringify(a)),b.executeSql(e,j,k,f))})});return this},batch:function(a,d){for(var b=[],c=!1,e=this,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      h=function(d){b.push(d);c=b.length===a.length},k=setInterval(function(){c&&(d&&e.lambda(d).call(e,b),clearInterval(k))},200),j=0,g=a.length;j<g;j++)this.save(a[j],h);return this},get:function(a,d){var b=this,c="",c=this.isArray(a)?"SELECT id, value FROM "+this.name+" WHERE id IN ('"+a.join("','")+"')":"SELECT id, value FROM "+this.name+" WHERE id = '"+a+"'",e=function(c,e){var j=null,g=[];if(e.rows.length)for(var f=0,m=e.rows.length;f<m;f++)j=JSON.parse(e.rows.item(f).value),j.key=e.rows.item(f).id,
  g.push(j);b.isArray(a)||(g=g.length?g[0]:null);d&&b.lambda(d).call(b,g)};this.db.transaction(function(a){a.executeSql(c,[],e,f)});return this},exists:function(a,d){var b="SELECT * FROM "+this.name+" WHERE id = ?",c=this,e=function(a,b){d&&c.fn("exists",d).call(c,0<b.rows.length)};this.db.transaction(function(c){c.executeSql(b,[a],e,f)});return this},all:function(a){var d=this,b="SELECT * FROM "+this.name,c=[],e=this.fn(this.name,a)||void 0,h=function(a,b){if(0!=b.rows.length)for(var g=0,f=b.rows.length;g<
  f;g++){var h=JSON.parse(b.rows.item(g).value);h.key=b.rows.item(g).id;c.push(h)}e&&e.call(d,c)};this.db.transaction(function(a){a.executeSql(b,[],h,f)});return this},remove:function(a,d){var b=this,c="string"===typeof a?a:a.key,e="DELETE FROM "+this.name+" WHERE id = ?",h=function(){d&&b.lambda(d).call(b)};this.db.transaction(function(a){a.executeSql(e,[c],h,f)});return this},nuke:function(a){var d="DELETE FROM "+this.name,b=this,c=a?function(){b.lambda(a).call(b)}:function(){};this.db.transaction(function(a){a.executeSql(d,
  [],c,f)});return this}}}());

Lawnchair.adapter("indexed-db",(function(){function b(k,j){console.error("error in indexed-db adapter!",k,j);}var e="lawnchair";var h=2;var i=function(){return window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB;};var f=function(){return window.IDBTransaction||window.webkitIDBTransaction||window.mozIDBTransaction||window.oIDBTransaction||window.msIDBTransaction;};var g=function(){return window.IDBKeyRange||window.webkitIDBKeyRange||window.mozIDBKeyRange||window.oIDBKeyRange||window.msIDBKeyRange;};var a=function(){return window.IDBDatabaseException||window.webkitIDBDatabaseException||window.mozIDBDatabaseException||window.oIDBDatabaseException||window.msIDBDatabaseException;};var c=function(){return !!window.indexedDB;};var d=(f()&&"READ_WRITE" in f())?f().READ_WRITE:"readwrite";return{valid:function(){return !!i();},init:function(l,p){this.idb=i();this.waiting=[];this.useAutoIncrement=c();var m=this.idb.open(this.name,h);var k=this;var j=k.fn(k.name,p);var o=function(){m.onupgradeneeded=m.onsuccess=m.error=null;return j.call(k,k);};var n=function(u,t){try{k.db.deleteObjectStore("teststore");}catch(s){}try{k.db.deleteObjectStore(e);}catch(q){}var r={};if(k.useAutoIncrement){r.autoIncrement=true;}k.db.createObjectStore(e,r);k.store=true;};m.onupgradeneeded=function(q){k.db=m.result;k.transaction=m.transaction;n(q.oldVersion,q.newVersion);};m.onsuccess=function(s){k.db=m.result;if(k.db.version!=(""+h)){var q=k.db.version;var t=k.db.setVersion(""+h);t.onsuccess=function(u){var v=t.result;t.onsuccess=t.onerror=null;n(q,h);v.oncomplete=function(){for(var w=0;w<k.waiting.length;w++){k.waiting[w].call(k);}k.waiting=[];o();};};t.onerror=function(u){t.onsuccess=t.onerror=null;console.log("Failed to create objectstore "+u);b(u);};}else{k.store=true;for(var r=0;r<k.waiting.length;r++){k.waiting[r].call(k);}k.waiting=[];o();}};m.onerror=function(q){if(m.errorCode===a().VERSION_ERR){k.idb.deleteDatabase(k.name);return k.init(l,p);}console.error("Failed to open database");};},save:function(o,p){if(!this.store){this.waiting.push(function(){this.save(o,p);});return;}var k=this,m;var n=function(q){m.onsuccess=m.onerror=null;if(p){o.key=q.target.result;k.lambda(p).call(k,o);}};var l=this.db.transaction(e,d);var j=l.objectStore(e);if(o.key){m=j.put(o,o.key);}else{if(this.useAutoIncrement){m=j.put(o);}else{m=j.put(o,this.uuid());}}m.onsuccess=n;m.onerror=b;return this;},batch:function(q,r){var p=[],k=q.length,n=this;var m=function(l){n.save(q[l],function(s){p[l]=s;if((--k)>0){return;}if(r){n.lambda(r).call(n,p);}});};for(var o=0,j=q.length;o<j;o++){m(o);}return this;},get:function(r,s){if(!this.store){this.waiting.push(function(){this.get(r,s);});return;}var u=this;var p=function(v){var l=v.target.result;if(s){if(l){l.key=r;}u.lambda(s).call(u,l);}};if(!this.isArray(r)){var q=this.db.transaction(e).objectStore(e).get(r);q.onsuccess=function(l){q.onsuccess=q.onerror=null;p(l);};q.onerror=function(l){console.log("Failed to find "+r);q.onsuccess=q.onerror=null;b(l);};}else{var o=[],m=r.length,t=r;var j=function(l){u.get(t[l],function(v){o[l]=v;if((--m)>0){return;}if(s){u.lambda(s).call(u,o);}});};for(var n=0,k=t.length;n<k;n++){j(n);}}return this;},exists:function(k,m){if(!this.store){this.waiting.push(function(){this.exists(k,m);});return;}var j=this;var l=this.db.transaction(e).objectStore(e).openCursor(g().only(k));l.onsuccess=function(o){l.onsuccess=l.onerror=null;var n;j.lambda(m).call(j,o.target.result!==null&&o.target.result!==n);};l.onerror=function(n){l.onsuccess=l.onerror=null;console.log("Failed to test for "+k);b(n);};return this;},all:function(n){if(!this.store){this.waiting.push(function(){this.all(n);});return;}var j=this.fn(this.name,n)||undefined;var k=this;var l=this.db.transaction(e).objectStore(e);var m=[];l.openCursor().onsuccess=function(o){var p=o.target.result;if(p){m.push(p.value);p["continue"]();}else{if(j){j.call(k,m);}}};return this;},keys:function(n){if(!this.store){this.waiting.push(function(){this.keys(n);});return;}var j=this.fn(this.name,n)||undefined;var k=this;var l=this.db.transaction(e).objectStore(e);var m=[];l.openCursor().onsuccess=function(o){var p=o.target.result;if(p){m.push(p.key);p["continue"]();}else{if(j){j.call(k,m);}}};return this;},remove:function(j,q){if(!this.store){this.waiting.push(function(){this.remove(j,q);});return;}var r=this;if(this.isArray(j)){var n,m=j.length;var k=function(s){r.remove(j[s],function(){if((--m)>0){return;}if(q){r.lambda(q).call(r);}});};for(n=0;n<j.length;n++){k(n);}return this;}var l;var o=function(){l.onsuccess=l.onerror=null;if(q){r.lambda(q).call(r);}};var p=j.key?j.key:j;l=this.db.transaction(e,d).objectStore(e)["delete"](p);l.onsuccess=o;l.onerror=b;return this;},nuke:function(m){if(!this.store){this.waiting.push(function(){this.nuke(m);});return;}var j=this,l=m?function(){j.lambda(m).call(j);}:function(){};try{this.db.transaction(e,d).objectStore(e).clear().onsuccess=l;}catch(k){b();}return this;}};})());